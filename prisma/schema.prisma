// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// AUTH & BILLING
// ============================================

enum UserRole {
  ADMIN
  CUSTOMER
}

model Plan {
  id              String   @id @default(cuid())
  name            String   @unique  // "starter" | "pro" | "team"
  displayName     String
  priceUsd        Int                // cents: 0, 2900, 9900
  creditsPerCycle Int
  maxProjects     Int                // -1 = unlimited
  allowedAgents   String[]           // e.g. ["ux","backend"] or ["*"]
  rolloverMonths  Int      @default(0)
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())

  users           User[]
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  passwordHash  String
  name          String?
  role          UserRole  @default(CUSTOMER)

  // Billing
  planId        String?
  plan          Plan?     @relation(fields: [planId], references: [id])
  creditBalance Int       @default(0)

  // Relations
  creditTxns    CreditTxn[]
  sessions      Session[]
  projects      Project[]
  tasks         Task[]

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([email])
  @@index([role])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expires      DateTime

  @@index([userId])
}

model CreditTxn {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  taskId    String?
  delta     Int      // negative = debit, positive = top-up
  reason    String   // "task_run" | "plan_topup" | "monthly_reset" | "admin_adjust" | "sepay_payment"
  meta      Json?    // e.g. { sepayTxnId, tokensUsed }
  timestamp DateTime @default(now())

  @@index([userId])
  @@index([timestamp])
}

// ============================================
// 1. VPS Management
// ============================================
model VPS {
  id          String   @id @default(cuid())
  name        String   @unique
  ip          String
  port        Int      @default(22)
  username    String
  sshKeyPath  String?
  status      VPSStatus @default(DISCONNECTED)

  region      String?
  provider    String?
  tags        String[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  lastPingAt  DateTime?

  deployments Deployment[]
  agentLogs   AgentLog[]
  commands    CommandHistory[]

  @@index([status])
  @@index([ip])
}

enum VPSStatus {
  CONNECTED
  DISCONNECTED
  ERROR
  MAINTENANCE
}

// ============================================
// 2. Agent System
// ============================================
model Agent {
  id          String   @id @default(cuid())
  name        String   @unique
  type        AgentType
  status      AgentStatus @default(IDLE)

  config      Json?
  capabilities String[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  lastActiveAt DateTime?

  logs        AgentLog[]
  commands    CommandHistory[]
  deployments Deployment[]

  @@index([type])
  @@index([status])
}

enum AgentType {
  DEVOPS
  SECURITY
  BACKEND
  FRONTEND
  QA
  ORCHESTRATOR
}

enum AgentStatus {
  IDLE
  THINKING
  EXECUTING
  WAITING
  ERROR
}

enum ModelProvider {
  CLAUDE
  GEMINI
  DEEPSEEK
  GPT4O
  OLLAMA
}

// ============================================
// 7. Project System
// ============================================
model Project {
  id          String   @id @default(cuid())
  name        String
  description String?
  stack       Json     @default("{}")

  // Owner
  userId      String?
  user        User?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  tasks       Task[]

  @@index([createdAt])
  @@index([userId])
}

// ============================================
// 8. Task System
// ============================================
model Task {
  id            String   @id @default(cuid())
  userRequest   String
  summary       String?
  status        TaskStatus @default(PENDING)
  assignedRole  String?
  results       String[]

  // Owner
  userId        String?
  user          User?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  // Credit cost
  creditCost    Int      @default(0)

  projectId     String?
  project       Project? @relation(fields: [projectId], references: [id])

  createdAt     DateTime @default(now())
  startedAt     DateTime?
  completedAt   DateTime?

  subTasks      SubTask[]

  @@index([status])
  @@index([createdAt])
  @@index([projectId])
  @@index([userId])
}

enum TaskStatus {
  PENDING
  THINKING
  EXECUTING
  SUCCESS
  FAILED
  WAITING_APPROVAL
}

// ============================================
// 9. Agent Skills
// ============================================
model AgentSkill {
  id          String   @id @default(cuid())
  name        String
  description String?
  agentRole   String   @default("all")
  content     String   @db.Text
  sourceUrl   String?
  sourceAuthor String?
  stackTriggers Json?
  isActive    Boolean  @default(true)
  priority    Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([agentRole])
  @@index([isActive])
}

// ============================================
// 10. Agent Memory
// ============================================
model AgentMemory {
  id          String     @id @default(cuid())
  agentRole   String
  projectId   String?
  memoryType  MemoryType @default(SHORT_TERM)
  content     String     @db.Text
  taskId      String?
  importance  Int        @default(0)
  createdAt   DateTime   @default(now())

  @@index([agentRole])
  @@index([projectId])
  @@index([memoryType])
  @@index([createdAt])
}

enum MemoryType {
  SHORT_TERM
  LESSON
}

model ProjectSummary {
  id          String   @id @default(cuid())
  projectId   String   @unique
  content     String   @db.Text
  taskCount   Int      @default(0)
  updatedAt   DateTime @updatedAt
  createdAt   DateTime @default(now())

  @@index([projectId])
}

model SubTask {
  id          String   @id @default(cuid())
  taskId      String
  task        Task     @relation(fields: [taskId], references: [id])
  agentRole   String
  description String
  status      TaskStatus @default(PENDING)
  results     String[]
  createdAt   DateTime @default(now())
  completedAt DateTime?

  @@index([taskId])
  @@index([agentRole])
}

// ============================================
// 3. Command History & Security
// ============================================
model CommandHistory {
  id          String   @id @default(cuid())
  command     String
  rawInput    String?
  sanitized   String?
  isBlocked   Boolean  @default(false)
  blockReason String?
  riskLevel   RiskLevel @default(LOW)
  status      CommandStatus @default(PENDING)
  exitCode    Int?
  stdout      String?
  stderr      String?
  duration    Int?
  agent       Agent    @relation(fields: [agentId], references: [id])
  agentId     String
  vps         VPS?     @relation(fields: [vpsId], references: [id])
  vpsId       String?
  deployment  Deployment? @relation(fields: [deploymentId], references: [id])
  deploymentId String?
  createdAt   DateTime @default(now())
  executedAt  DateTime?
  completedAt DateTime?

  @@index([agentId])
  @@index([vpsId])
  @@index([status])
  @@index([isBlocked])
  @@index([createdAt])
}

enum CommandStatus {
  PENDING
  APPROVED
  EXECUTING
  SUCCESS
  FAILED
  BLOCKED
  TIMEOUT
}

enum RiskLevel {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

// ============================================
// 4. Agent Logs
// ============================================
model AgentLog {
  id          String   @id @default(cuid())
  message     String
  type        LogType  @default(INFO)
  level       LogLevel @default(INFO)
  agent       Agent    @relation(fields: [agentId], references: [id])
  agentId     String
  vps         VPS?     @relation(fields: [vpsId], references: [id])
  vpsId       String?
  metadata    Json?
  tags        String[]
  timestamp   DateTime @default(now())

  @@index([agentId])
  @@index([vpsId])
  @@index([type])
  @@index([timestamp])
}

enum LogType {
  INFO
  WARN
  ERROR
  SUCCESS
  REASONING
  EXECUTION
  SECURITY
}

enum LogLevel {
  DEBUG
  INFO
  WARN
  ERROR
  CRITICAL
}

// ============================================
// 5. Deployment Management
// ============================================
model Deployment {
  id          String   @id @default(cuid())
  projectName String
  repository  String?
  branch      String?
  commitHash  String?
  status      DeploymentStatus @default(PENDING)
  progress    Int      @default(0)
  agent       Agent    @relation(fields: [agentId], references: [id])
  agentId     String
  vps         VPS      @relation(fields: [vpsId], references: [id])
  vpsId       String
  commands    CommandHistory[]
  logs        String?
  errorMessage String?
  createdAt   DateTime @default(now())
  startedAt   DateTime?
  completedAt DateTime?

  @@index([agentId])
  @@index([vpsId])
  @@index([status])
  @@index([createdAt])
}

enum DeploymentStatus {
  PENDING
  PREPARING
  BUILDING
  DEPLOYING
  SUCCESS
  FAILED
  ROLLBACK
}

// ============================================
// 6. System Metrics
// ============================================
model SystemMetric {
  id          String   @id @default(cuid())
  vpsId       String
  cpuUsage    Float?
  memoryUsage Float?
  diskUsage   Float?
  networkIn   Float?
  networkOut  Float?
  timestamp   DateTime @default(now())

  @@index([vpsId])
  @@index([timestamp])
}
